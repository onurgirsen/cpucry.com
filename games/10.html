<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Replicating Pixels â€” Crashy Demo</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121933;
      --text: #dfe6ff;
      --muted: #93a0c8;
      --accent: #6aa3ff;
      --danger: #ff5b6a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100svh;
      background: radial-gradient(1200px 600px at 70% -10%, #1b2550 0%, var(--bg) 50%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      padding: 16px 20px;
      display: flex; align-items: center; gap: 14px; flex-wrap: wrap;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; opacity: .95; }
    .badge { padding: 4px 8px; border-radius: 999px; background: #1a244b; color: var(--muted); font-size: 12px; }

    .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 0 20px 20px; }
    @media (max-width: 900px) { .wrap { grid-template-columns: 1fr; } }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.25);
    }
    .controls { display: grid; gap: 12px; }
    .row { display: grid; gap: 8px; align-items: center; }
    .row > label { font-size: 12px; color: var(--muted); }
    input[type="range"] { width: 100%; }

    .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      appearance: none; border: none; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer;
      background: #1e2a57; color: var(--text); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .05s ease, filter .15s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .primary { background: linear-gradient(180deg, #2d5fff, #2347b6); }
    .danger { background: linear-gradient(180deg, var(--danger), #cc2b40); }

    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px; }
    .stat {
      background: #0e1533; border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 10px;
      display: grid; gap: 4px;
    }
    .stat small { color: var(--muted); font-size: 11px; }
    .stat strong { font-variant-numeric: tabular-nums; }

    canvas { width: 100%; height: 100%; display: block; background: #040714; border-radius: 16px; border: 1px solid rgba(255,255,255,.06); }
    .canvas-wrap { position: relative; min-height: 60svh; }
    .watermark { position: absolute; right: 8px; bottom: 8px; font-size: 10px; color: #7f8bb3; opacity: .7; }

    footer { padding: 12px 20px; color: var(--muted); font-size: 12px; opacity: .9; }
    kbd { background: #1b254e; border: 1px solid rgba(255,255,255,.13); padding: 2px 6px; border-radius: 6px; font-size: 11px; }
  </style>
</head>
<body>
  <header>
    <h1>Replicating Pixels</h1>
    <span class="badge">resource-hungry demo</span>
  </header>

  <section class="wrap">
    <aside class="panel">
      <div class="controls">
        <div class="row">
          <label for="mult">Replication factor <span id="multVal"></span></label>
          <input id="mult" type="range" min="1" max="5" step="0.1" value="2"/>
        </div>
        <div class="row">
          <label for="pxsize">Pixel size <span id="pxVal"></span></label>
          <input id="pxsize" type="range" min="1" max="8" step="1" value="2"/>
        </div>
        <div class="row">
          <label for="spawn">Initial spawn</label>
          <select id="spawn">
            <option value="center">Center</option>
            <option value="random">Random</option>
            <option value="line">Middle line</option>
          </select>
        </div>
        <div class="buttons">
          <button id="start" class="primary">Start</button>
          <button id="pause">Pause</button>
          <button id="reset">Reset</button>
          <button id="panic" class="danger" title="Stop animation immediately and clear the scene">PANIC</button>
        </div>
        <div class="buttons">
          <button id="crash" class="danger">ðŸ’¥ Crash Mode</button>
        </div>
        <div class="stats">
          <div class="stat"><small>Pixel count</small><strong id="count">0</strong></div>
          <div class="stat"><small>FPS (approx)</small><strong id="fps">0</strong></div>
        </div>
        <p style="margin-top:8px;color:var(--muted);font-size:12px;line-height:1.4">
          <strong>Heads up:</strong> Increasing the replication factor and enabling Crash Mode can freeze the browser or close the tab. <br>
          <em>Safe exit:</em> Use <kbd>Esc</kbd> or the <strong>PANIC</strong> button.
        </p>
      </div>
    </aside>

    <main class="panel canvas-wrap">
      <canvas id="cv"></canvas>
      <div class="watermark">v1.2 Â· replicating-pixels (1s step)</div>
    </main>
  </section>

  <footer>
    Resource-hungry demo: Every <strong>1 second</strong> pixels replicate and are drawn individually. CPU and memory usage will ramp up over time.
  </footer>

<script>
(() => {
  const canvas = document.getElementById('cv');
  const ctx = canvas.getContext('2d', { alpha: false });
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function resize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
  }
  window.addEventListener('resize', resize, { passive: true });
  resize();

  const $ = (id) => document.getElementById(id);
  const countEl = $('count');
  const fpsEl = $('fps');
  const multEl = $('mult');
  const multVal = $('multVal');
  const sizeEl = $('pxsize');
  const pxVal = $('pxVal');
  const spawnEl = $('spawn');
  const startBtn = $('start');
  const pauseBtn = $('pause');
  const resetBtn = $('reset');
  const panicBtn = $('panic');
  const crashBtn = $('crash');

  let pixels = [];
  let running = false;
  let crashMode = false;
  let lastFps = performance.now();
  let frames = 0;
  let lastStep = 0; // for fixed update cadence

  function randInt(min, max) { return (Math.random() * (max - min + 1) + min) | 0; }
  function randColor() {
    const h = Math.random();
    const s = 70 + Math.random() * 30;
    const l = 55 + Math.random() * 25;
    const a = s/100 * Math.min(l/100, 1 - l/100);
    function f(n){
      const k = (n + h*12) % 12;
      const c = l/100 - a * Math.max(-1, Math.min(k-3, Math.min(9-k,1)));
      return (c*255)|0;
    }
    return `rgb(${f(0)},${f(8)},${f(4)})`;
  }

  function spawnInitial(kind) {
    pixels.length = 0;
    const size = +sizeEl.value * dpr;
    if (kind === 'random') {
      for (let i=0;i<25;i++) {
        pixels.push({ x: randInt(0, canvas.width), y: randInt(0, canvas.height), c: randColor(), s: size });
      }
    } else if (kind === 'line') {
      const y = (canvas.height/2)|0;
      for (let x=0; x<canvas.width; x+=Math.max(2, size)) {
        pixels.push({ x, y, c: randColor(), s: size });
      }
    } else {
      pixels.push({ x: canvas.width>>1, y: canvas.height>>1, c: randColor(), s: size });
    }
  }

  function drawPixel(p) {
    ctx.fillStyle = p.c;
    ctx.fillRect(p.x, p.y, p.s, p.s);
  }

  function computeReplicationCount(mult) {
    // Make the slider feel continuous: fractional multiplier is handled probabilistically.
    const base = Math.floor(mult);
    const frac = mult - base;
    return base + (Math.random() < frac ? 1 : 0);
  }

  function step(time){
    if (!running) return;

    // FPS (approx)
    frames++;
    const dt = time - lastFps;
    if (dt >= 500) {
      const fps = (frames / (dt/1000)).toFixed(0);
      fpsEl.textContent = fps;
      frames = 0; lastFps = time;
    }

    // UPDATE INTERVAL: 1,000 ms
    if (time - lastStep >= 1000) {
      lastStep = time;
      const mult = crashMode ? 4 : Math.max(1, +multEl.value);
      const size = (crashMode ? 1 : +sizeEl.value) * dpr;

      const current = pixels;
      const add = [];

      for (let i=0; i<current.length; i++) {
        const p = current[i];
        drawPixel(p);
        const n = computeReplicationCount(mult);
        for (let k=0; k<n; k++) {
          const nx = p.x + randInt(-p.s*2, p.s*2);
          const ny = p.y + randInt(-p.s*2, p.s*2);
          const x = Math.max(0, Math.min(canvas.width-1, nx));
          const y = Math.max(0, Math.min(canvas.height-1, ny));
          add.push({ x, y, c: (k%2 ? p.c : randColor()), s: size });
        }
      }

      pixels = current.concat(add);
      countEl.textContent = pixels.length.toLocaleString('en-US');
    }

    requestAnimationFrame(step);
  }

  function start() {
    if (running) return;
    running = true;
    requestAnimationFrame(step);
  }
  function pause() { running = false; }
  function reset() {
    running = false;
    crashMode = false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    spawnInitial(spawnEl.value);
    countEl.textContent = pixels.length.toLocaleString('en-US');
  }

  // UI bindings
  multVal.textContent = '(' + multEl.value + 'x/update)';
  multEl.addEventListener('input', () => { multVal.textContent = '(' + multEl.value + 'x/update)'; });
  pxVal.textContent = '(' + sizeEl.value + 'px)';
  sizeEl.addEventListener('input', () => { pxVal.textContent = '(' + sizeEl.value + 'px)'; });

  startBtn.addEventListener('click', () => start());
  pauseBtn.addEventListener('click', () => pause());
  resetBtn.addEventListener('click', () => reset());
  panicBtn.addEventListener('click', () => { running = false; ctx.clearRect(0,0,canvas.width,canvas.height); pixels.length = 0; countEl.textContent = '0'; });
  crashBtn.addEventListener('click', () => {
    crashMode = true;
    pixels.length = 0;
    pixels.push({ x: canvas.width>>1, y: canvas.height>>1, c: randColor(), s: 1 * dpr });
    multEl.value = 4; multVal.textContent = '(4x/update)';
    sizeEl.value = 1; pxVal.textContent = '(1px)';
    if (!running) start();
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      panicBtn.click();
    }
  });

  // Initial scene
  spawnInitial(spawnEl.value);
  countEl.textContent = pixels.length.toLocaleString('en-US');
})();
</script>
</body>
</html>
